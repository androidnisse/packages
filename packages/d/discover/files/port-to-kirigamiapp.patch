From d30b9317fdeee26d98a5f7e92c386fa0643b4536 Mon Sep 17 00:00:00 2001
From: Aleix Pol <aleixpol@kde.org>
Date: Mon, 25 Aug 2025 03:17:48 +0200
Subject: [PATCH] discover: Port to KirigamiApp

Allows us to delegate certain infrastructure logic away.
---
 CMakeLists.txt          |  2 +-
 discover/CMakeLists.txt |  1 +
 discover/main.cpp       | 15 +++------------
 3 files changed, 5 insertions(+), 13 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 5c14699278..0422a8af50 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -41,7 +41,7 @@ find_package(AppStreamQt 1.0.4 CONFIG REQUIRED)
 find_package(KF6Attica ${KF6_MIN_VERSION} CONFIG)
 find_package(KF6NewStuff ${KF6_MIN_VERSION} CONFIG)
 
-find_package(KF6KirigamiAddons REQUIRED)
+find_package(KF6KirigamiAddons 1.10.0 REQUIRED)
 set_package_properties(KF6KirigamiAddons PROPERTIES
     TYPE REQUIRED
     PURPOSE "Provides additional visual components"
diff --git a/discover/CMakeLists.txt b/discover/CMakeLists.txt
index 55bc79ed60..68553b5802 100644
--- a/discover/CMakeLists.txt
+++ b/discover/CMakeLists.txt
@@ -51,6 +51,7 @@ target_link_libraries(plasma-discover PUBLIC
                                      KF6::JobWidgets
                                      KF6::StatusNotifierItem
                                      KF6::I18nQml
+                                     KirigamiApp
                                      Qt::Widgets
                                      Qt::Quick
                                      Qt::QuickControls2
diff --git a/discover/main.cpp b/discover/main.cpp
index 838c1bc843..e6eca5704f 100644
--- a/discover/main.cpp
+++ b/discover/main.cpp
@@ -10,14 +10,12 @@
 #include "DiscoverVersion.h"
 #include <DiscoverBackendsFactory.h>
 #include <KAboutData>
-#include <KCrash>
 #include <KDBusService>
 #include <KLocalizedString>
 #include <KWindowSystem>
 #include <QApplication>
 #include <QCommandLineParser>
 #include <QDir>
-#include <QQuickStyle>
 #include <QStandardPaths>
 #include <QSurfaceFormat>
 #include <QTextStream>
@@ -26,6 +24,7 @@
 #include <QtWebView>
 #endif
 
+#include <KirigamiApp>
 #include <QProcessEnvironment>
 
 std::unique_ptr<QCommandLineParser> createParser()
@@ -111,19 +110,11 @@ int main(int argc, char **argv)
     QtWebView::initialize();
 #endif
 
-    auto format = QSurfaceFormat::defaultFormat();
-    format.setOption(QSurfaceFormat::ResetNotification);
-    QSurfaceFormat::setDefaultFormat(format);
+    KirigamiApp::App app(argc, argv);
+    KirigamiApp kapp;
 
-    // Default to org.kde.desktop style unless the user forces another style
-    if (qEnvironmentVariableIsEmpty("QT_QUICK_CONTROLS_STYLE")) {
-        QQuickStyle::setStyle(QStringLiteral("org.kde.desktop"));
-    }
-    QApplication app(argc, argv);
     app.setWindowIcon(QIcon::fromTheme(QStringLiteral("plasmadiscover")));
-    app.setAttribute(Qt::AA_DontCreateNativeWidgetSiblings);
     app.setQuitLockEnabled(false);
-    KCrash::initialize();
     KLocalizedString::setApplicationDomain("plasma-discover");
     KAboutData about(QStringLiteral("discover"),
                      i18n("Discover"),
-- 
GitLab

